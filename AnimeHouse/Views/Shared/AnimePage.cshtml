@using AnimeHouse.Data
@using AnimeHouse.ViewModels.AnimeModels;
@using Microsoft.AspNetCore.Identity
@using Microsoft.EntityFrameworkCore
@model AnimePageViewModel
@inject ApplicationContext db
<!doctype html>
<html>
	<head>
		<base href="/" />
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-EVSTQN3/azprG1Anm3QDgpJLIm9Nao0Yz1ztcQTwFspd3yD65VohhpuuCOmLASjC" crossorigin="anonymous">
		<title>Home Page</title>
		<meta charset="utf-8" />
		<link rel="stylesheet" href="/css/StyleSheet.css">
	</head>
	@{
		User user =  db.Users.Include(u=> u.Animes).FirstOrDefault(u => u.UserName == User.Identity.Name);
	}
	<body>
		<header>
			<nav>
		 
				<ul>
				  <li><a class="active" asp-action="Main" asp-controller="Home">Home</a></li>
				@if (User.IsInRole("admin") || @User.IsInRole("moderator"))
				{
					<li><a asp-action="UserList" asp-controller="Admin">User's List</a></li>
					<li><a asp-action="CreateTitle" asp-controller="Admin" >Create Title</a></li>
				}
				<li><a asp-action="GetListAnime" asp-controller="Anime">Anime</a></li>
				@if(User.Identity.IsAuthenticated) {
					<li><a asp-action="Services" asp-controller="Profile">@User.Identity.Name</a></li>
		
					<li>
						<form method="post" asp-controller="Account" asp-action="Logout">
							<input type="submit" value="Выход" />
						</form>
					</li>
				}
				else {
					<li><a asp-controller="Account" asp-action="Login">Login</a></li>
					<li><a asp-controller="Account" asp-action="Registration">Registration</a></li>
				}
				</ul>
			</nav>
		</header>
		<h1>@Model.SearchedAnime.TitleName</h1>
		<h2>@Model.SearchedAnime.Description</h2>
		<h2>Episods count: @Model.SearchedAnime.CountEpisodes</h2>
		@if(User.Identity.IsAuthenticated)
		{
			@if(user.Animes.FirstOrDefault(a => a.TitleName == @Model.SearchedAnime.TitleName) != null)
			{
				<form asp-action="DeleteFromFavorite" asp-controller="Anime" method="post">
					 <input hidden name="animeId" value="@Model.SearchedAnime.Id" >
					 <input hidden name="userId" value="@user.Id">
					 <input type="submit" value="Delete From favorite">
				 </form>

			}
			else
			{
				 <form asp-action="AddToFavorite" asp-controller="Anime" method="post">
					 <input hidden name="animeId" value="@Model.SearchedAnime.Id" >
					 <input hidden name="userId" value="@user.Id">
					 <input type="submit" value="Add to favorite">
				 </form>
			}


		}

	<video controls="controls" autoplay="autoplay" height="300" width="400">
		<source  src="animes\KomiSan\episods\episod1.mp4" type='video/mp4;codecs="avc1.42E01E, mp4a.40.2"'/>
	</video>

	<h3>Comments</h3>
	@if(!User.Identity.IsAuthenticated) {
		<h4>Comments can be left by registered users</h4>
	}
	else
	{

		<h4>Leave Comment</h4>
		<form asp-action="LeaveСomment" asp-controller="Anime" method="post">
			<input hidden name="userName" type="text" value="@user.UserName">
			<input hidden name="animeId" type="number" value="@Model.SearchedAnime.Id">
			<textarea name="text" cols="30" rows="50"></textarea>
			<input type="submit" value="Leave">
		</form>
	}
	<h4>All comments</h4>
	@if (User.IsInRole("admin") || @User.IsInRole("moderator")) {
		@foreach (var comment in db.Comments.Where(c => c.AnimeId == @Model.SearchedAnime.Id))
		{
			<div>
				<form method="post" asp-action="DeleteComment" asp-controller="Admin">
					<input value="@comment.UserName" name="userName" hidden>
					<input value="@Model.SearchedAnime.Id" name="animeId" hidden>
					<input value="@comment.Text" name="text" hidden>
					<input type="submit" value="Удалить">
				</form>
				<h5>@comment.UserName</h5>
				<p>@comment.Text</p>
			</div><br/>
		}
	}
	else {
		@foreach (var comment in db.Comments.Where(c => c.AnimeId == @Model.SearchedAnime.Id))
		{
			<div>
				<h5>@comment.UserName</h5>
				<p>@comment.Text</p>
			</div><br/>
		}
	}

	</body>
</html>


